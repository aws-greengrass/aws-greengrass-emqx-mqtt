--- emqx.cmd	(revision 8010e148d6dd88bfb8dc120b766476c6781b7e11)
+++ emqx.cmd	(date 1675472348728)
@@ -33,11 +33,23 @@
 @set rel_dir=%rel_root_dir%\releases\%rel_vsn%
 @set RUNNER_ROOT_DIR=%rel_root_dir%

-@set etc_dir=%rel_root_dir%\etc
+@if defined EMQX_NODE__ETC_DIR (
+  set etc_dir=%EMQX_NODE__ETC_DIR%
+) else (
+  @set etc_dir=%rel_root_dir%\etc
+)
 @set lib_dir=%rel_root_dir%\lib
-@set data_dir=%rel_root_dir%\data
+@if defined EMQX_NODE__DATA_DIR (
+  set data_dir=%EMQX_NODE__DATA_DIR%
+) else (
+  @set data_dir=%rel_root_dir%\data
+)
 @set emqx_conf=%etc_dir%\emqx.conf

+:: Ensure erlang has the right dlls
+@set greengrass_auth_plugin_bin_dir=%rel_root_dir%\lib\aws_greengrass_emqx_auth-1.0.0\priv
+@set PATH=%greengrass_auth_plugin_bin_dir%;%PATH%
+
 @call :find_erts_dir
 @call :find_vm_args
 @call :find_sys_config
@@ -67,7 +79,7 @@
 )

 :: Write the erl.ini file to set up paths relative to this script
-@call :write_ini
+:: @call :write_ini

 :: If a start.boot file is not present, copy one from the named .boot file
 @if not exist "%rel_dir%\start.boot" (
@@ -142,7 +154,7 @@
 @goto :eof

 :generate_app_config
-@set gen_config_cmd=%escript% %cuttlefish% -i %rel_dir%\emqx.schema -c %etc_dir%\emqx.conf -d %data_dir%\configs generate
+@set gen_config_cmd=%escript% %cuttlefish% -i %rel_dir%\emqx.schema -c %emqx_conf% -d %data_dir%\configs generate
 @for /f "delims=" %%A in ('%%gen_config_cmd%%') do @(
   set generated_config_args=%%A
 )
@@ -217,6 +229,15 @@
 :: window service?
 :: @%erlsrv% stop %service_name%
 @%escript% %nodetool% %node_type% %node_name% -setcookie %node_cookie% stop
+@IF %ERRORLEVEL% NEQ 0 (
+    @exit /b
+)
+:TryPinging
+@%escript% %nodetool% ping %node_type% "%node_name%" -setcookie "%node_cookie%"
+@IF %ERRORLEVEL% EQU 0 (
+    @goto TryPinging
+)
+@%epmd% -kill
 @goto :eof

 :: Relup and reldown
@@ -236,11 +257,9 @@
 @call :create_mnesia_dir
 @call :generate_app_config
 @set args=%sys_config% %generated_config_args% -mnesia dir '%mnesia_dir%'
-@echo off
-cd /d %rel_root_dir%
 @echo on
-%erl_exe% -boot "%boot_script%" %args%
-@echo emqx is started!
+@title "%rel_root_dir%\bin\%rel_name% console"
+@%erl_exe% -noshell -boot "%boot_script%" %args% || exit /b
 @goto :eof
 
 :: Ping the running node
