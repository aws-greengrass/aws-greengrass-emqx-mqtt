--- emqx.cmd	2022-08-31 07:20:47.000000000 -0400
+++ emqx.cmd	2022-09-01 13:52:36.000000000 -0400
@@ -35,12 +35,23 @@
 @for %%A in ("%script_dir%\..") do @(
   set rel_root_dir=%%~fA
 )
+@if exist %rel_root_dir% (
+  cd /d %rel_root_dir%
+)
 @set rel_dir=%rel_root_dir%\releases\%rel_vsn%
 @set RUNNER_ROOT_DIR=%rel_root_dir%
 
-@set etc_dir=%rel_root_dir%\etc
+@if defined EMQX_NODE__ETC_DIR (
+  set etc_dir=%EMQX_NODE__ETC_DIR%
+) else (
+  @set etc_dir=%rel_root_dir%\etc
+)
 @set lib_dir=%rel_root_dir%\lib
-@set data_dir=%rel_root_dir%\data
+@if defined EMQX_NODE__DATA_DIR (
+  set data_dir=%EMQX_NODE__DATA_DIR%
+) else (
+  @set data_dir=%rel_root_dir%\data
+)
 @set emqx_conf=%etc_dir%\emqx.conf
 
 @call :find_erts_dir
@@ -72,7 +83,7 @@
 )
 
 :: Write the erl.ini file to set up paths relative to this script
-@call :write_ini
+:: @call :write_ini
 
 :: If a start.boot file is not present, copy one from the named .boot file
 @if not exist "%rel_dir%\start.boot" (
@@ -149,7 +160,7 @@
 @goto :eof
 
 :generate_app_config
-@set gen_config_cmd=%escript% %cuttlefish% -i %rel_dir%\emqx.schema -c %etc_dir%\emqx.conf -d %data_dir%\configs generate
+@set gen_config_cmd=%escript% %cuttlefish% -i %rel_dir%\emqx.schema -c %emqx_conf% -d %data_dir%\configs generate
 @for /f "delims=" %%A in ('%%gen_config_cmd%%') do @(
   set generated_config_args=%%A
 )
@@ -224,6 +235,15 @@
 :: window service?
 :: @%erlsrv% stop %service_name%
 @%escript% %nodetool% %node_type% %node_name% -setcookie %node_cookie% stop
+@IF %ERRORLEVEL% NEQ 0 (
+    @exit /b
+)
+:TryPinging
+@%escript% %nodetool% ping %node_type% "%node_name%" -setcookie "%node_cookie%"
+@IF %ERRORLEVEL% EQU 0 (
+    @goto TryPinging
+)
+@%epmd% -kill
 @goto :eof
 
 :: Relup and reldown
@@ -243,11 +263,9 @@
 @call :create_mnesia_dir
 @call :generate_app_config
 @set args=%sys_config% %generated_config_args% -mnesia dir '%mnesia_dir%'
-@echo off
-cd /d %rel_root_dir%
 @echo on
-%erl_exe% -boot "%boot_script%" %args%
-@echo emqx is started!
+@title "%rel_root_dir%\bin\%rel_name% console"
+@%erl_exe% -noshell -boot "%boot_script%" %args% || exit /b
 @goto :eof
 
 :: Ping the running node
