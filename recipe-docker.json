{
  "RecipeFormatVersion": "2020-01-25",
  "ComponentName": "aws.greengrass.clientdevices.mqtt.EMQX",
  "ComponentType": "aws.greengrass.generic",
  "ComponentDescription": "The EMQX MQTT broker component provides an MQTT v5 broker, based on the EMQX MQTT broker, for client devices to connect to your Greengrass core device.\n\nOn Windows operating systems this software includes code distributed under the Microsoft Software License Terms - Microsoft Visual Studio Community 2022. By downloading this software, you agree to that code's license terms, which can be found at https://visualstudio.microsoft.com/license-terms/vs2022-ga-community.",
  "ComponentPublisher": "AWS",
  "ComponentConfiguration": {
    "DefaultConfiguration": {
      "emqx": {
        "log.enabled": "true",
        "log.level": "debug",
        "listener.ssl.mtls.bind": "8883"
      },
      "accessControl": {
        "aws.greengrass.clientdevices.Auth": {
          "aws.greengrass.clientdevices.mqtt.EMQX:auth:1": {
            "policyDescription": "Access to client device auth operations.",
            "operations": [
              "aws.greengrass#SubscribeToCertificateUpdates",
              "aws.greengrass#VerifyClientDeviceIdentity",
              "aws.greengrass#GetClientDeviceAuthToken",
              "aws.greengrass#AuthorizeClientDeviceAction"
            ],
            "resources": [
              "*"
            ]
          }
        }
      },
      "crtLogLevel": "",
      "requiresPrivilege": "true",
      "restartIdentifier": "",
      "startupTimeoutSeconds": "90",
      "ipcTimeoutSeconds": "5"
    }
  },
  "ComponentDependencies": {
    "aws.greengrass.clientdevices.Auth": {
      "VersionRequirement": ">=2.2.0 <2.5.0",
      "DependencyType": "SOFT"
    }
  },
  "Manifests": [
    {
      "Platform": {
        "os": "linux"
      },
      "Lifecycle": {
        "install": {
          "requiresPrivilege": "{configuration:/requiresPrivilege}",
          "script": "docker rmi aws-greengrass-emqx:amd64\ndocker load --input {artifacts:path}/aws-greengrass-emqx.amd64.tar.gz"
        },
        "startup": {
          "requiresPrivilege": "{configuration:/requiresPrivilege}",
          "timeout": "{configuration:/startupTimeoutSeconds}",
          "script": "docker run --rm --name emqx -p {configuration:/emqx/listener.ssl.mtls.bind}:{configuration:/emqx/listener.ssl.mtls.bind} -v $AWS_GG_NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT:$AWS_GG_NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT -e SVCUID -e AWS_GG_NUCLEUS_DOMAIN_SOCKET_FILEPATH_FOR_COMPONENT -e EMQX_LISTENERS__SSL__MTLS__BIND -e EMQX_LOG__CONSOLE_HANDLER__ENABLE -e EMQX_LOG__CONSOLE_HANDLER__LEVEL -e CRT_LOG_LEVEL -e IPC_TIMEOUT_SECONDS -e RESTART_IDENTIFIER aws-greengrass-emqx:amd64",
          "setEnv": {
            "EMQX_LISTENERS__SSL__MTLS__BIND": "{configuration:/emqx/listener.ssl.mtls.bind}",
            "EMQX_LOG__CONSOLE_HANDLER__ENABLE": "{configuration:/emqx/log.enabled}",
            "EMQX_LOG__CONSOLE_HANDLER__LEVEL": "{configuration:/emqx/log.level}",
            "RESTART_IDENTIFIER": "{configuration:/restartIdentifier}",
            "CRT_LOG_LEVEL":  "{configuration:/crtLogLevel}",
            "IPC_TIMEOUT_SECONDS": "{configuration:/ipcTimeoutSeconds}"
          }
        },
        "shutdown": {
          "requiresPrivilege": "{configuration:/requiresPrivilege}",
          "script": "docker stop emqx"
        }
      },
      "Artifacts": [
        {
          "URI": "s3://BUCKET_NAME/COMPONENT_NAME/COMPONENT_VERSION/aws-greengrass-emqx.amd64.tar.gz"
        }
      ]
    }
  ]
}
